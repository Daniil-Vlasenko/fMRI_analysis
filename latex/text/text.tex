% !TeX spellcheck = ru_RU
\documentclass[specialist,
substylefile = spbu_report.rtx,
subf,href,colorlinks=true, 12pt]{disser}

\usepackage{amsmath,amssymb,amsthm,amscd,amsfonts, mathtools}
\usepackage[utf8]{inputenc}
\usepackage[a4paper,
left=2cm, right=1.5cm, top=2cm, bottom=2cm]{geometry}
\usepackage{graphicx}
\usepackage[russian]{babel}
\usepackage{xcolor}
\usepackage{float}

\makeatletter
\newcommand*{\rom}[1]{\expandafter\@slowromancap\romannumeral #1@}
\newcommand\setItemnumber[1]{\setcounter{enum\romannumeral\@enumdepth}{\numexpr#1-1\relax}}
\makeatother


\setcounter{tocdepth}{3}
\setcounter{secnumdepth}{3}


\newtheorem{defenition}{Определение}
\newtheorem*{purpose*}{Цель работы}
\newtheorem*{prob_task*}{Вероятностная постановка задачи классификации}
\newtheorem*{algo_task*}{Алгоритмическая постановка задачи классификации}
\newtheorem*{prob_def*}{Вероятностное определение $w_{ij}^k$}
\newtheorem*{algo_def*}{Алгоритмическое определение $w_{ij}^k$}

\begin{document}
	\institution{%
		Санкт-Петербургский государственный университет\\
		Прикладная математика и информатика
	}
	
	\title{Отчет по Научно-исследовательской работе}	
	\topic{Задачи классификации мозговой активности при помощи синолитических сетей}	
	\author{Власенко Даниил Владимирович}
	\group{группа 19.Б04-мм}
	\sa{Шпилёв Пётр Валерьевич\\
		Кафедра Статистического Моделирования}
	\sastatus {к.\,ф.-м.\,н., доцент}	
	\city{Санкт-Петербург}
	\date{\number\year}	
	\maketitle
	\tableofcontents
	
	\intro
		\section{Функциональная магнитно-резонансная томография}
			Функциональная магнитно-резонансная томография или фМРТ — разновидность магнитно-резонансной томографии, которая проводится с целью измерения изменений в токе крови, вызванных нейронной активностью головного мозга. 
			
			Этот метод основывается на том, что мозговой кровоток и активность нейронов связаны между собой. Когда область мозга активна, приток крови к этой области также увеличивается. 
			
			Испытуемый помещается в фМРТ аппарат, снимки мозга испытуемого происходят последовательно с интервалом в несколько секунд или миллисекунд. Таким образом результатом работы фМРТ аппарата является объемное трехмерное изображение, изменяющееся во времени, в центре которого расположен зафиксированный неподвижный мозг. Значение вокселя фМРТ в конкретный момент времени отображает концентрацию крови в данной области мозга.
	
			фМРТ позволяет определить активацию определенной области головного мозга во время нормального его функционирования под влиянием различных факторов (например, движение тела) и при различных патологических состояниях. Эти знания помогают понять, как из согласованной работы частей мозга складываются высшие психические функции, такие как память, внимание, мышление. 
			
			На сегодняшний день это один из самых активно развивающихся видов нейровизуализации. С начала 1990-х годов фМРТ стала доминировать в области визуализации процессов головного мозга из-за своей сравнительно низкой инвазивности, отсутствия воздействия радиации и относительно широкой доступности.
			
			Большой интерес вызывает способность различать поведение человека и его деятельность на основе данных нейровизуализации. Будем считать, что мозг может функционировать в двух режимах. Как по результатам фМРТ сканирования определить, в каком из двух режимов был мозг? 
			
		\section{Векторизация данных фМРТ}
			Результатом работы фМРТ сканера является последовательность трехмерных изображений, таким образом единицой данных является воксель изображения в конкретный момент дискретного времени. Наиболее распространенным форматом хранения фМРТ данных является NIFTI формат.   Библиотека Nibabel~\cite{} позволяет читать NIFTI формат и представляет его в памяти как четырехмерный массив действительных чисел, где первые три координаты фиксируют положение вокселя в пространстве, а четвертная отвечает за время. Значение массива отображает концентрацию крови в данном вокселе в данный момент времени.
			
		\section{Представление мозга как сети}
			Мозг --- это сложная сеть, а фМРТ отражает работу этой сети во времени. Для эффективной классификации на основе такого сложного типа больших данных нужно использовать методы, которые будут учитывать взаимосвязи между элементами входящими в сеть.
			
			Идея данной работы заключается в том, чтобы строить на основе данных фМРТ графы, вершины которых будут отражать области мозга, а веса ребер – взаимосвязь между областями при конкретном режиме мозговой активности. После подобного представления мозга будут использоваться методы машинного обучения, которые будут учитывать характеристики графов при обучении и последующей классификации.
			
			Метод построения графов, который я модифицировал для поставленной задачи и который изложу далее, называется синолитическим. Его эффективность при классификации была подтверждена при исследованиях других типов биологических данных~\cite{DemichevV2022}.			
		
			\begin{purpose*}
				Реализация и тестирование метода классификации режимов мозговой активности на основе фМРТ данных, в основе которого будут лежать синолитические сети.
			\end{purpose*}
		
		\section{Классификация}
			Для дальнейшей работы формализуем термин “классификация”. 
			\begin{defenition}
				Пусть $X$ --- множество объектов, $Y$ --- множество номеров классов. Существует неизвестная функция $f: X \rightarrow Y$, значения которой известны только на объектах выборки $(\widetilde{X}, \widetilde{Y}) =  \{(x_{n}, y_{n})\}_n$. Требуется построить алгоритм-оценку $\widehat{f}: X \rightarrow Y$, способный классифицировать произвольный объект $x \in X$.
			\end{defenition}
		
			Такой алгоритм будем называть моделью. Таким образом требуется построить модель, которая смогла бы по данным фМРТ определить в каком из двух режимов мозговой активности был мозг.
		
	\chapter{Модель}	
		Множество фМРТ будем обозначать $X$, а множество режимом мозговой активности~--- $Y = \{$\rom{1}, \rom{2}$\}$. $(\widetilde{X}, \widetilde{Y}) =  \{(x_{n}, y_{n})\}_n$ --- конечная выборка из $(X, Y)$, необходимая для построения модели.				
		
		\section{Построение графа на основе фМРТ}
			Метод построения графов, модифицированный под задачи классификации мозговой активности на основе фМРТ данных и изложенный в этом разделе, называется синолитическим. Каждая вершина в графе будет отражать воксель в фМРТ данных, ребра между вершинами и веса ребер будут отражать взаимосвязь вокселей. 			
			
			Сначала с помощью библиотеки Nibabel $x \in X$ конвертируется в четырехмерный массив~$a$. Первые три индекса $x$, $y$, $z$ фиксируют положение вокселя фМРТ, а четвертый индекс $t$ отвечает за время. Таким образом через $a_{xyzt}$ будем обозначать значение вокселя с индексами $x$, $y$, $z$ в момент времени $t$, а через $a_{xyz}$ будем обозначать все значения вокселя с индексами $x$, $y$, $z$. Иногда будет удобно использовать для индексации конкретного вокселя не три целых числа, а одно. Для этого положим, что задана биекция между индексами $x$, $y$, $z$ и некоторым индексом $i$.		
			
			На основе массив $a$ в дальнейшем будет строится граф $g = (V, E, R, W)$, где $V = \{v_i\}_i$~--- множество вершин, $E = \{e_{ij}\}_{ij}$~--- множество неориентированных ребер, $R = \{r_i\}_i$~--- множество значений вершин, $W = \{w_{ij}\}_{ij}$~--- множество весов ребер, $v_i$~--- вершина, отражающая воксель $i$, $e_{ij}$~--- ребро, отражающее связь между вокселями $i$ и $j$, $r_i$~--- значение вершины $v_i$, $w_{ij}$~--- вес ребра $e_{ij}$.
			
			Обсудим как вычисляются значения вершин $R$. Как было сказано выше вершина $v_i$ отражает собой воксель $i$ и у нее есть значение $r_i$, но воксель $i$ это временной ряд с множеством значений. Для вычисления $r_i$ в модели используется статистика $T$, которая будет преобразовывать все значения вокселя в одно число. Таким образом можно ввести новый трехмерный массив $a^{T} = T(a)$, т.е для $\forall x, y, z$ $a^{T}_{xyz} = T(a_{xyz})$. Значения массива $a^{T}$ и будут использоваться в качестве значений вершин R. Статистика $T$ будет выбираться исходя из результатов тестирования модели.
			
			Наиболее важно то, каким образом вычисляются значения весов ребер $W$, потому что веса ребер отражают взаимодействия между вокселями при разных режимах работы мозга. Дадим сначала теоретическое определение для $w_{ij}$:					
			\begin{equation}
				w_{ij} = P(y_k = \rom{2} | r_i, r_j) - P(y = \rom{1} | r_i, r_j)
				\label{eq:1}
			\end{equation}		
			Таким образом вес ребра $w_{ij}$ равен разнице вероятностей режимов работы мозга при условии значений инцидентных ребру вершин и принимает значения от $-1$ до $1$. Соответственно, если вес ребра $w_{ij} < 0$ , то ребро $e_{ij}$ несет в себе информацию о том, что более вероятно, что фМРТ было сканировано с мозга, который находился в режиме \rom{1}, а если вес ребра $w_{ij} > 0$, то данное ребро несет в себе информацию о том, что более вероятно, что фМРТ было сканировано с мозга, который находился в режиме \rom{2}. Чем больше вес ребра $|w_{ij}|$ тем больше информации для классификации несет в себе ребро $e_{ij}$.
		
			На практике для вычисления таких вероятностей используются вероятностные классификаторы $Cl_{ij}: \{y |(r_i, r_j), \{(r_i^n, r_j^n)\}_n, \{y_n\}_n\} \rightarrow [0, 1]$, которые обучаются на имеющейся выборке $(\widetilde{X}, \widetilde{Y})$. Можно переписать формулу~\eqref{eq:1} так:
			\begin{equation}
				\begin{multlined}
					w_{ij} = Cl_{ij}(y = \rom{2} | (r_i, r_j), \{(r_i^n, r_j^n)\}_n, \{y_n\}_n) - \\ - Cl_{ij}(y = \rom{1} | (r_i, r_j), \{(r_i^n, r_j^n)\}_n, \{y_n\}_n)
				\end{multlined}
				\label{eq:2}
			\end{equation}
			Таким образом для каждого ребра $e_{ij}$ требуется обучить свой вероятностный классификатор $Cl_{ij}$ для последующего вычисления весов ребер $W$. В данной работе используются вероятностные классификаторы $Cl_{ij}$, в основе которых лежит метод опорных векторов~\cite{}.
			
			Теперь когда известно каким образом считаются значения вершин $R$ и значения ребер $W$, можно описать топологию графа. Как правило~\cite{} при построении синолитических сетей строится полный граф, что позволяет учитывать взаимодействия между всеми элементами сети. В случае данных фМРТ вершин в графе получается много, что приведет такому количеству ребер при построении полного графа, что модель будет неэффективной. Например, если разрешение фМРТ $100\times100\times100$ вокселей, то в графе будет $1.000.000$ вершин и $\frac{1.000.000 \cdot 999.999}{2} = 499.999.500.000$ ребер. И для каждого ребра $e_{ij}$ нужно обучать свой классификатор $Cl_{ij}$, это приводит к большим затратам памяти и вычислительного времени.
			
			Вместо полного графа предлагается строить не полный граф, а граф-сетку, то есть такой граф, в котором каждый внутренний воксель связан с 26 своими соседями. То есть воксель $a_{xyz}$ связан с вокселями из множества $\{a_{\hat{x}\hat{y}\hat{z}}: \hat{x} \in \{x- 1,x, x +1\}, \hat{y} \in \{y- 1,y, y +1\}, \hat{z} \in \{z- 1,z, z +1\}, (\hat{x}\hat{y}\hat{z}) \neq (xyz)\}$. При такой топологии графа число затраты на память и вычислительное время сократиться с $O(n^2)$ до $O(n)$.
			
			Так как в фМРТ изображен не только мозг, но и пространство вокруг головы испытуемого, следует удалить из графа ребра, которые инциденты с вершинами, значения которых ниже порогового значения $r$. Такие ребра не несут полезной информации для классификации. Так же из графа следует удалить ребра, абсолютное значение веса которых ниже порогового значения $w$. Ребра, абсолютное значение веса которых близко к нулю, так же не несут полезной информации для классификации.
			
		\section{Классификация на основе характеристик графа}
			После построения графа $g$ считаются его характеристики $\{f_u\}_u = \{F_u(g)\}_u$, таким образом от графа остается последовательность чисел $\{f_u\}_u$. В качестве характеристик графа $\{F_u(g)\}_u$ могут выступать среднее весов ребер, дисперсия весов ребер, количество компонент связности и т.д. Характеристики $\{F_u(g)\}_u$ будут выбраны по результатам работы модели. На основе $\{f_u\}_u$ происходит итоговая классификация фМРТ данных $x$ с помощью классификатора $Cl$, который был обучен на выборке $\{\{f_u^n\}_u\}_n$. В качестве классификатора в работе использовался классификатор, основанный на методе опорных векторов\cite{}.
			
		\section{Алгоритм}
			Изложим теперь алгоритм обучения модели и классификации с ее помощью. 
						
			\subsection{Обучение}
				Входные данные: выборка $(\widetilde{X}, \widetilde{Y})$, статистика вокселей $T$, минимальное значение вершины $r$, для которого инцидентные с ним ребра не удаляются из графа, минимальное абсолютное значение ребра $w$, для которого ребро не удаляется из графа,характеристики графов $\{F_u\}_u$, на которых будет обучаться модель.			
				
				Последовательность шагов обучения модели:
				\begin{enumerate}
					\item Построение $\{a^n\}_n$ для $\forall x \in \widetilde{X}$;
					\item Вычисление $\{a^{Tn}\}_n$ и, соответственно, $R$ с помощью $T$;
					\item Обучение  $\{Cl_{ij}\}_{ij}$ на выборке $(\{(r_i^n, r_j^n)\}_n, \{y_n\}_n)$ для $\forall e_{ij} \in E$;
					\item Вычисление $\{W_n\}_n = \{\{w_{ij}^n\}_{ij}\}_n$ с помощью $\{Cl_{ij}\}_{ij}$ и $R$;
					\item Построение графов-сеток $\{g_n\}_n$;
					\item Удаление ребер $\{e_{ij}^n : r_i^n < r | r_j^n < r | w_{ij}^n < w\}_{ij}$  для $\forall g_n$;
					\item Вычисление $\{\{f^n_u\}_u\}_n = \{\{F_u(g_n)\}_u\}_n$;
					\item Обучение $Cl$ на выборке $\{\{f^n_u\}_u\}_n$.
				\end{enumerate}
			
			\subsection{Классификация}
				Входные данные: фМРТ $x$, статистика вокселей $T$, минимальное значение вершины $r$, для которого инцидентные с ним ребра не удаляются из графа, минимальное абсолютное значение ребра $w$, для которого ребро не удаляется из графа,характеристики графов $\{F_u\}_u$, на которых будет обучаться модель.
				
				Последовательность шагов классификации с помощью модели:				
				\begin{enumerate}
					\item Построение $a$;
					\item Вычисление $a^{T}$ и, соответственно, $R$ с помощью $T$;
					\item Вычисление $W = \{w_{ij}\}_{ij}$ с помощью $\{Cl_{ij}\}_{ij}$ и $R$;
					\item Построение графа-сетки $g$;
					\item Удаление ребер $\{e_{ij} : r_i < r | r_j < r | w_{ij} < w\}_{ij}$  для $g$;
					\item Вычисление $\{f^n_u\}_u = \{F_u(g)\}_u$;
					\item Классификация $\{f^n_u\}_u$ с помощью $Cl$.
				\end{enumerate}
				
	
	
	
	
	
	   
	\bibliographystyle{ugost2008mod}
	\bibliography{references}
	
	
	
\end{document}
